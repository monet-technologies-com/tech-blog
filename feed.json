{
    "version": "https://jsonfeed.org/version/1",
    "title": "MONET Tech-Blog",
    "description": "This is a tech-blog of MONET-Technologies",
    "home_page_url": "https://monet-technologies-com.github.io/tech-blog",
    "items": [
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/09/22/%E3%82%AA%E3%83%B3%E3%83%87%E3%83%9E%E3%83%B3%E3%83%89%E3%83%90%E3%82%B9%E6%9C%80%E9%81%A9%E5%8C%96%E3%81%AE%E3%82%A8%E3%83%83%E3%82%BB%E3%83%B3%E3%82%B91/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/09/22/%E3%82%AA%E3%83%B3%E3%83%87%E3%83%9E%E3%83%B3%E3%83%89%E3%83%90%E3%82%B9%E6%9C%80%E9%81%A9%E5%8C%96%E3%81%AE%E3%82%A8%E3%83%83%E3%82%BB%E3%83%B3%E3%82%B91/",
            "title": "オンデマンドバス最適化のエッセンス1",
            "date_published": "2020-09-22T15:43:00.000Z",
            "content_html": "<h1 id=\"はじめに\"><a class=\"markdownIt-Anchor\" href=\"#はじめに\">#</a> はじめに</h1>\n<p>システム部の竹内です。</p>\n<p>今回の記事では、少し真面目に理論的なことを考えていきたいと思います。</p>\n<p>MONET ではオンデマンドバスを提供するパッケージを提供していますが、<br>\n配送の最適化は昔から学術的にも考えられている問題です。</p>\n<p>今回は理論的に最適化問題を解く流れを見ながら、<br>\n配送最適化のエッセンスを感じていただければと思います。</p>\n<h2 id=\"一般的にオンデマンドバスを捉える\"><a class=\"markdownIt-Anchor\" href=\"#一般的にオンデマンドバスを捉える\">#</a> 一般的にオンデマンドバスを捉える</h2>\n<p>まず、そもそも「オンデマンドバスの最適化」とはどんな問題なのでしょうか。<br>\n最適化問題を理論的に考えるときには、まず、</p>\n<ol>\n<li>何が事前情報として与えられるのか</li>\n<li>何を決定するのか</li>\n<li>どんな観点で決定を評価するのか</li>\n</ol>\n<p>と言った観点を明らかにする必要があります。</p>\n<p>今回考えたいオンデマンドバスのシチュエーションでは、例えば、</p>\n<p><strong>何が事前情報として与えられるのか：</strong></p>\n<ul>\n<li>バスが何台か存在する\n<ul>\n<li>一度に運べる乗客の積載容量は決まっている</li>\n</ul>\n</li>\n<li>乗客が乗降するための駅が何箇所か存在する\n<ul>\n<li>駅間には距離が定義される</li>\n</ul>\n</li>\n<li>利用希望の乗客が何人か存在する\n<ul>\n<li>出発駅と到着駅のペア</li>\n</ul>\n</li>\n</ul>\n<p><strong>何を決定するのか：</strong></p>\n<ul>\n<li>乗客が、いつ、どの車に乗るか (配車割当)</li>\n<li>車が、どのような経路で駅間を移動するか (配送経路)</li>\n</ul>\n<p><strong>どんな観点で決定を評価するのか：</strong></p>\n<ul>\n<li>全ての車の配送経路の総和</li>\n</ul>\n<p>として整理することができます。</p>\n<p><img src=\"2020-09-23T101757.png\" alt=\"2020-09-23T101757\"></p>\n<p>もちろん、問題の捉え方によっては、他の整理の仕方があります。<br>\n例えば、乗客が決まった出発駅を持たず、現在地から近ければ近いほど好ましい状況、というシチュエーションも考えられます。</p>\n<p>ただ、いずれにせよ、最適化を理論的に考える場合には、最低限上記の 3 点を明確に正しく把握しておくことは重要です。</p>\n<h2 id=\"よくある運搬経路最適化問題vrp\"><a class=\"markdownIt-Anchor\" href=\"#よくある運搬経路最適化問題vrp\">#</a> よくある運搬経路最適化問題 (VRP)</h2>\n<p>上記問題の詳細を考える問題として、<br>\n運搬経路最適化問題 (Vehicle Routing Problem) があります。<br>\nこの問題は、巡回セールスマン問題を複数人で分担して行うことを考える問題になっています。</p>\n<p>理解しやすい解説として、以下の Qiita 記事がよくまとまっています。</p>\n<p><a href=\"https://qiita.com/r_nsd/items/19dcb30f5478384f90d3\">運搬経路問題（配送最適化問題，Vehicle Routing Problem) を PuLP で解く</a></p>\n<p>VRP の特徴として、</p>\n<ul>\n<li>全てのバスは車庫から出発して車庫に戻ってくる</li>\n<li>計画を立てるタイミングで全ての予約が出揃っている</li>\n</ul>\n<p>などの問題設定がなされています。</p>\n<p>こちらも重要なポイントですが、<br>\n実社会にみられる問題は、既に考えられている問題に帰着できる場合があります。<br>\nこのとき、帰着先の問題において、問題設定にどのような前提があるのかをよく理解しながら帰着させることが重要です。</p>\n<p>今回の問題を VRP として捉えると、</p>\n<ul>\n<li>バスはキャパシティを持つ</li>\n<li>乗客は出発地と目的地を持つ</li>\n</ul>\n<p>という観点から、VRP の派生問題である CVRPPD (Capacitated VRP with Pick-up and Delivery) という問題として捉えることができます。</p>\n<h2 id=\"vrpのソルバー\"><a class=\"markdownIt-Anchor\" href=\"#vrpのソルバー\">#</a> VRP のソルバー</h2>\n<p>考えている問題が何か有名な問題に帰着できる場合 (今回は VRP)、多くの場合既にソルバー (問題を解くためのプログラム / アルゴリズム) が存在します。</p>\n<p>今回考えている VRP には、<br>\n<a href=\"https://developers.google.com/optimization/routing/vrp\">OR-tools</a><br>\n という OSS ソルバーが存在しています。</p>\n<p>こちらのようなソルバーを使うと、CVRPPD をプログラムに落とし込むことができます。<br>\nつまり、駅や車のキャパシティ、乗客の出発地、目的地などのパラメータを与えることによって、<br>\nプログラムを用いて最適な配送計画を計算することができます。</p>\n<p>ただし、利用するソルバーによっては、</p>\n<ul>\n<li>与えられるパラメータに制限がつく\n<ul>\n<li>各駅について、高々一人が出発地または目的地に設定する (出発地、目的地の重複がない) 状況しか考えられない</li>\n<li>駅数などパラメータの数に制限がつく</li>\n</ul>\n</li>\n<li>処理時間はソルバー依存</li>\n</ul>\n<p>と言った問題点が出てくる場合もあります。</p>\n<p>ここでのポイントとしては、</p>\n<ul>\n<li>考えている問題の規模によって、ソルバーを選ぶ必要がある\n<ul>\n<li>パラメータの数、処理時間の要求</li>\n</ul>\n</li>\n<li>帰着させた問題によっては、ソルバーにあう形で新たな制限 (仮定) を置かなければならない場合がある</li>\n<li>何らかの高速なソルバーが存在する場合には、帰着させる問題を工夫して、ソルバーで解きやすい形の問題に帰着させることも考慮する</li>\n</ul>\n<p>といったものが挙げられます。</p>\n<h2 id=\"実際のプログラム\"><a class=\"markdownIt-Anchor\" href=\"#実際のプログラム\">#</a> 実際のプログラム</h2>\n<p>せっかくなので、OR-tools を使って CVRPPD を解くプログラムをみてみます。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><div class=\"caption\"><span>src.py</span></div><code class=\"language-python\"><span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> print_function\n<span class=\"token keyword\">from</span> ortools<span class=\"token punctuation\">.</span>constraint_solver <span class=\"token keyword\">import</span> routing_enums_pb2\n<span class=\"token keyword\">from</span> ortools<span class=\"token punctuation\">.</span>constraint_solver <span class=\"token keyword\">import</span> pywrapcp\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">create_data_model</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\"># 17箇所の駅</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'distance_matrix'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">548</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">696</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">582</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span> <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span> <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">548</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">684</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span> <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">696</span><span class=\"token punctuation\">,</span> <span class=\"token number\">742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1084</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">594</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">480</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">674</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1016</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">868</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1210</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">684</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">992</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span> <span class=\"token number\">810</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">,</span> <span class=\"token number\">742</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1278</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1130</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">788</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1552</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">754</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">696</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">992</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">114</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">650</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span> <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">844</span><span class=\"token punctuation\">,</span> <span class=\"token number\">890</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1232</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">628</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">822</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1164</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">560</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1358</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">582</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">114</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span> <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span> <span class=\"token number\">776</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1118</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">400</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">708</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1050</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">674</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1244</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">650</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">228</span><span class=\"token punctuation\">,</span> <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">582</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">628</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1050</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">708</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">228</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span> <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1004</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">890</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">856</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1278</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">480</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">810</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">342</span><span class=\"token punctuation\">,</span> <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">320</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">742</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">856</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">696</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">844</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span> <span class=\"token number\">342</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">810</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">696</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">320</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1084</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">742</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">742</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">890</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">240</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">,</span> <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">342</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">422</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">810</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">468</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">536</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1084</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1232</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1118</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">582</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span> <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span> <span class=\"token number\">342</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1152</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">502</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">594</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1278</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">400</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">776</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1004</span><span class=\"token punctuation\">,</span> <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">810</span><span class=\"token punctuation\">,</span> <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">878</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">114</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">650</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">844</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">480</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1164</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">628</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">890</span><span class=\"token punctuation\">,</span> <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">696</span><span class=\"token punctuation\">,</span> <span class=\"token number\">422</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">114</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">674</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1130</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">822</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">708</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">628</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">856</span><span class=\"token punctuation\">,</span> <span class=\"token number\">320</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">662</span><span class=\"token punctuation\">,</span> <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">308</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">342</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">422</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">468</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1016</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">788</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1050</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span> <span class=\"token number\">662</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">320</span><span class=\"token punctuation\">,</span> <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">650</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">342</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">776</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">868</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1552</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">560</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">674</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1050</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1278</span><span class=\"token punctuation\">,</span> <span class=\"token number\">742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1084</span><span class=\"token punctuation\">,</span> <span class=\"token number\">810</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1152</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">274</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">388</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">422</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">764</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">798</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span> <span class=\"token number\">662</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1210</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">754</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1358</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1244</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">708</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">480</span><span class=\"token punctuation\">,</span> <span class=\"token number\">856</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">514</span><span class=\"token punctuation\">,</span> <span class=\"token number\">468</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">354</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">844</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">730</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">536</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">194</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">798</span><span class=\"token punctuation\">,</span>    <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 8人分の予約(ODペア)が発生</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'pickups_deliveries'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 車が4台</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'num_vehicles'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n    <span class=\"token comment\"># 各駅について、出発駅として設定されている場合は需要1、</span>\n    <span class=\"token comment\"># 到着駅として設定されている場合には需要-1(降りることを表現)</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'demands'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 各車の最大積載容量</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'vehicle_capacities'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 車庫</span>\n    data<span class=\"token punctuation\">[</span><span class=\"token string\">'depot'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">return</span> data\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">print_solution</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> manager<span class=\"token punctuation\">,</span> routing<span class=\"token punctuation\">,</span> solution<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Prints solution on console.\"\"\"</span>\n    total_distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">for</span> vehicle_id <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'num_vehicles'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        index <span class=\"token operator\">=</span> routing<span class=\"token punctuation\">.</span>Start<span class=\"token punctuation\">(</span>vehicle_id<span class=\"token punctuation\">)</span>\n        plan_output <span class=\"token operator\">=</span> <span class=\"token string\">'Route for vehicle &#123;&#125;:\\n'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>vehicle_id<span class=\"token punctuation\">)</span>\n        route_distance <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> routing<span class=\"token punctuation\">.</span>IsEnd<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            plan_output <span class=\"token operator\">+=</span> <span class=\"token string\">' &#123;&#125; -> '</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">.</span>IndexToNode<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            previous_index <span class=\"token operator\">=</span> index\n            index <span class=\"token operator\">=</span> solution<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">(</span>routing<span class=\"token punctuation\">.</span>NextVar<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            route_distance <span class=\"token operator\">+=</span> routing<span class=\"token punctuation\">.</span>GetArcCostForVehicle<span class=\"token punctuation\">(</span>\n                previous_index<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">,</span> vehicle_id<span class=\"token punctuation\">)</span>\n        plan_output <span class=\"token operator\">+=</span> <span class=\"token string\">'&#123;&#125;\\n'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">.</span>IndexToNode<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        plan_output <span class=\"token operator\">+=</span> <span class=\"token string\">'Distance of the route: &#123;&#125;m\\n'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>route_distance<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>plan_output<span class=\"token punctuation\">)</span>\n        total_distance <span class=\"token operator\">+=</span> route_distance\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Total Distance of all routes: &#123;&#125;m'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>total_distance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Entry point of the program.\"\"\"</span>\n    <span class=\"token comment\"># Instantiate the data problem.</span>\n    data <span class=\"token operator\">=</span> create_data_model<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Create the routing index manager.</span>\n    manager <span class=\"token operator\">=</span> pywrapcp<span class=\"token punctuation\">.</span>RoutingIndexManager<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'distance_matrix'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                            data<span class=\"token punctuation\">[</span><span class=\"token string\">'num_vehicles'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'depot'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Create Routing Model.</span>\n    routing <span class=\"token operator\">=</span> pywrapcp<span class=\"token punctuation\">.</span>RoutingModel<span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Define cost of each arc.</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">distance_callback</span><span class=\"token punctuation\">(</span>from_index<span class=\"token punctuation\">,</span> to_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"Returns the manhattan distance between the two nodes.\"\"\"</span>\n        <span class=\"token comment\"># Convert from routing variable Index to distance matrix NodeIndex.</span>\n        from_node <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span>IndexToNode<span class=\"token punctuation\">(</span>from_index<span class=\"token punctuation\">)</span>\n        to_node <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span>IndexToNode<span class=\"token punctuation\">(</span>to_index<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'distance_matrix'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>from_node<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>to_node<span class=\"token punctuation\">]</span>\n\n    transit_callback_index <span class=\"token operator\">=</span> routing<span class=\"token punctuation\">.</span>RegisterTransitCallback<span class=\"token punctuation\">(</span>distance_callback<span class=\"token punctuation\">)</span>\n    routing<span class=\"token punctuation\">.</span>SetArcCostEvaluatorOfAllVehicles<span class=\"token punctuation\">(</span>transit_callback_index<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Add Distance constraint.</span>\n    dimension_name <span class=\"token operator\">=</span> <span class=\"token string\">'Distance'</span>\n    routing<span class=\"token punctuation\">.</span>AddDimension<span class=\"token punctuation\">(</span>\n        transit_callback_index<span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># no slack</span>\n        <span class=\"token number\">2500</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># vehicle maximum travel distance</span>\n        <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># start cumul to zero</span>\n        dimension_name<span class=\"token punctuation\">)</span>\n    distance_dimension <span class=\"token operator\">=</span> routing<span class=\"token punctuation\">.</span>GetDimensionOrDie<span class=\"token punctuation\">(</span>dimension_name<span class=\"token punctuation\">)</span>\n    distance_dimension<span class=\"token punctuation\">.</span>SetGlobalSpanCostCoefficient<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">demand_callback</span><span class=\"token punctuation\">(</span>from_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"Returns the demand of the node.\"\"\"</span>\n        <span class=\"token comment\"># Convert from routing variable Index to demands NodeIndex.</span>\n        from_node <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span>IndexToNode<span class=\"token punctuation\">(</span>from_index<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'demands'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>from_node<span class=\"token punctuation\">]</span>\n\n    demand_callback_index <span class=\"token operator\">=</span> routing<span class=\"token punctuation\">.</span>RegisterUnaryTransitCallback<span class=\"token punctuation\">(</span>demand_callback<span class=\"token punctuation\">)</span>\n    routing<span class=\"token punctuation\">.</span>AddDimensionWithVehicleCapacity<span class=\"token punctuation\">(</span>\n        demand_callback_index<span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># null capacity slack</span>\n        data<span class=\"token punctuation\">[</span><span class=\"token string\">'vehicle_capacities'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># vehicle maximum capacities</span>\n        <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># start cumul to zero</span>\n        <span class=\"token string\">'Capacity'</span><span class=\"token punctuation\">)</span>\n\n\n\n    <span class=\"token comment\"># Define Transportation Requests.</span>\n    <span class=\"token keyword\">for</span> request <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'pickups_deliveries'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        pickup_index <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span>NodeToIndex<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        delivery_index <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span>NodeToIndex<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        routing<span class=\"token punctuation\">.</span>AddPickupAndDelivery<span class=\"token punctuation\">(</span>pickup_index<span class=\"token punctuation\">,</span> delivery_index<span class=\"token punctuation\">)</span>\n        routing<span class=\"token punctuation\">.</span>solver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Add<span class=\"token punctuation\">(</span>\n            routing<span class=\"token punctuation\">.</span>VehicleVar<span class=\"token punctuation\">(</span>pickup_index<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> routing<span class=\"token punctuation\">.</span>VehicleVar<span class=\"token punctuation\">(</span>\n                delivery_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        routing<span class=\"token punctuation\">.</span>solver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Add<span class=\"token punctuation\">(</span>\n            distance_dimension<span class=\"token punctuation\">.</span>CumulVar<span class=\"token punctuation\">(</span>pickup_index<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span>\n            distance_dimension<span class=\"token punctuation\">.</span>CumulVar<span class=\"token punctuation\">(</span>delivery_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Setting first solution heuristic.</span>\n    search_parameters <span class=\"token operator\">=</span> pywrapcp<span class=\"token punctuation\">.</span>DefaultRoutingSearchParameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    search_parameters<span class=\"token punctuation\">.</span>first_solution_strategy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        routing_enums_pb2<span class=\"token punctuation\">.</span>FirstSolutionStrategy<span class=\"token punctuation\">.</span>PARALLEL_CHEAPEST_INSERTION<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Solve the problem.</span>\n    solution <span class=\"token operator\">=</span> routing<span class=\"token punctuation\">.</span>SolveWithParameters<span class=\"token punctuation\">(</span>search_parameters<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Print solution on console.</span>\n    <span class=\"token keyword\">if</span> solution<span class=\"token punctuation\">:</span>\n        print_solution<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> manager<span class=\"token punctuation\">,</span> routing<span class=\"token punctuation\">,</span> solution<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>結構長々と書いてあって小難しく見えますが、<br>\n実際このプログラムの重要なところは <code>create_data_model()</code>  の中で、<br>\n問題のパラメータ (駅の数など) はこちらで指定できます。<br>\nここまでできれば、あとはソルバーがよしなに解いてくれます。</p>\n<p>実行結果としては、</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Route for vehicle 0:\n 0 -&gt;  13 -&gt;  15 -&gt;  11 -&gt;  12 -&gt; 0\nDistance of the route: 1552m\n\nRoute for vehicle 1:\n 0 -&gt;  5 -&gt;  2 -&gt;  10 -&gt;  16 -&gt;  14 -&gt;  9 -&gt; 0\nDistance of the route: 2192m\n\nRoute for vehicle 2:\n 0 -&gt;  7 -&gt;  1 -&gt;  6 -&gt;  8 -&gt; 0\nDistance of the route: 1780m\n\nRoute for vehicle 3:\n 0 -&gt;  4 -&gt;  3 -&gt; 0\nDistance of the route: 1392m\n\nTotal Distance of all routes: 6916m<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>として出力されます。</p>\n<p>このような一連の流れで、最適化問題は実際に解くことができます。</p>\n<p>一点注意したいのが、ソルバーによっては、導き出される解がグローバルに最適解でない<br>\n (ちょっと解を弄るだけでは状況を改善できないが、実は全く別の解を持ってくると改善される) 可能性も存在します。<br>\nグローバルな最適解かどうかは、ソルバーのアルゴリズムに依存するので、<br>\nどうしてもグローバルな最適解が必要な場合は注意が必要です。<br>\nただし、<strong>グローバルな最適解が本当に必要か</strong>、という観点もまた重要です。<br>\n例えば、処理時間を 1 日かけて 0.01% 改善する解を得ることは、<br>\n学術的には意味があるかもしれませんが、実際の社会に組み込む視点で見るとどうでしょう。<br>\nそれよりも、数秒で 90% の結果を得る方が、価値がある場合もありそうです。</p>\n<h1 id=\"まとめ\"><a class=\"markdownIt-Anchor\" href=\"#まとめ\">#</a> まとめ</h1>\n<p>最適化をするときは、</p>\n<ol>\n<li>問題から与えられる情報と目的、決定する項目を明らかにする</li>\n<li>有名な問題 / 解きやすい問題に帰着できないか検討</li>\n<li>問題をプログラムに落とし込んでソルバーに投げる</li>\n<li>出てきた解を解釈 / 利用する</li>\n</ol>\n<p>といった流れを組みます。<br>\nなかなか奥が深いですね。</p>\n<h1 id=\"終わりに\"><a class=\"markdownIt-Anchor\" href=\"#終わりに\">#</a> 終わりに</h1>\n<p>今回は問題を VRP に帰着しましたが、オンデマンドバスのシステム構成によっては、<br>\nVRP に帰着すると不都合な点もいくつかあります。<br>\nそのような場合には、VRP に帰着せず、より詳細に問題を定式化する必要があります。<br>\nそちらは、また他の記事でご紹介できればと思います。</p>\n",
            "tags": [
                "最適化",
                "VRP"
            ]
        },
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/08/30/%E3%83%AB%E3%83%BC%E3%83%88%E6%A4%9C%E7%B4%A2OSS%20(OSRM)%20%E3%81%AE%E4%BA%88%E6%B8%AC%E7%B2%BE%E5%BA%A6%E3%82%92%E8%AA%BF%E3%81%B9%E3%81%BE%E3%81%97%E3%81%9F/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/08/30/%E3%83%AB%E3%83%BC%E3%83%88%E6%A4%9C%E7%B4%A2OSS%20(OSRM)%20%E3%81%AE%E4%BA%88%E6%B8%AC%E7%B2%BE%E5%BA%A6%E3%82%92%E8%AA%BF%E3%81%B9%E3%81%BE%E3%81%97%E3%81%9F/",
            "title": "ルート検索OSS (OSRM) の予測精度を調べました (執筆中)",
            "date_published": "2020-08-30T19:06:55.000Z",
            "content_html": "<h1 id=\"執筆中の記事です-ドラフトです\"><a href=\"#執筆中の記事です-ドラフトです\" class=\"headerlink\" title=\"執筆中の記事です (ドラフトです)\"></a>執筆中の記事です (ドラフトです)</h1><p>システム部の登山担当太田です<br>山はいいぞ</p>\n<p>今回はルート検索のOSSであるOSRMを検証した話です<br>地図データにはOSMを用いています<br>導入は別で書きます</p>\n<h1 id=\"前談\"><a href=\"#前談\" class=\"headerlink\" title=\"前談\"></a>前談</h1><h2 id=\"ルート検索のコスト削減\"><a href=\"#ルート検索のコスト削減\" class=\"headerlink\" title=\"ルート検索のコスト削減\"></a>ルート検索のコスト削減</h2><p>MONETではオンデマンドバスサービスを提供していますが<br>その裏ではルート検索による時間取得のロジックが何度もはしっています<br>マッチングの最適化など今後進めていくにあたってもルート検索のコストは抑えたいところです<br>そこで信頼性をある程度担保して低コストなルート検索できないかな？<br>ということでOSSの有効性を検証しました</p>\n<h2 id=\"OSMとは\"><a href=\"#OSMとは\" class=\"headerlink\" title=\"OSMとは\"></a>OSMとは</h2><p>素晴らしい取り組みとしてOpen Street Map (OSM) という地理情報をみんなで作って行こうぜ！オープンライセンスで誰にでも使えるようにしようぜ！というイカしたプロジェクトがあります<br>Open Street Mapでは所々足りていない情報はありますが<br>道路のクラス分けや店舗の情報までオープンライセンスと考えれば十分すぎるほどの地理データが利用できます<br><img src=\"2020-08-31T130832.png\" alt=\"2020-08-31T130832\"></p>\n<div class=\"mdui-table-fluid theme-post__card__table--flat\"><table class=\"mdui-table mdui-table-hoverable \">\n<thead>\n<tr>\n<th></th>\n<th>OSMで利用可能な情報</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>○</td>\n<td>道路分類, 建物分類, 各名称</td>\n</tr>\n<tr>\n<td>×</td>\n<td>公共交通機関, 交通量</td>\n</tr>\n<tr>\n<td><br></td>\n<td></td>\n</tr>\n</tbody></table></div>\n<p>もちろん自分たちで編集ができ, 自宅の周りとか眺めてポチポチするだけで世界の地理データベース作成に貢献できるのでぜひやってみてください！</p>\n<h2 id=\"OSRMとは\"><a href=\"#OSRMとは\" class=\"headerlink\" title=\"OSRMとは\"></a>OSRMとは</h2><p>ルート検索エンジンのOSSです.<br>中身のアルゴリズムはmulti dikstraでOSMの地図情報を基に<br>最短ルートを決定します. (他のアルゴリズムも使用可)<br>高速道路を省いたり, Uターンを禁止したりなど<br>痒いところの設定までできてしまう優れものです.<br>Mapboxでも採用されていたりします.<a href=\"https://blog.mapbox.com/mapbox-directions-powered-by-osrm-4-8-1-cf2c45ae9aa8\">ブログ記事</a><br>ルート検索だけでなく<br>MapBoxでも採用されていたりします<br>このルート検索エンジン使ってどれくらい正しく予測できるの？<br>というのが今回のお題です</p>\n<h2 id=\"OSRMってどんな感じで動いてますん\"><a href=\"#OSRMってどんな感じで動いてますん\" class=\"headerlink\" title=\"OSRMってどんな感じで動いてますん\"></a>OSRMってどんな感じで動いてますん</h2><p>実装までは<a href=\"\">他記事</a>でも紹介されているので省きますが<br>ザクっとこんな感じです</p>\n<ol>\n<li>OSMの最新地図情報を保存</li>\n<li>luaファイル定義に従って重み付けされたグラフを作成</li>\n<li>HTTPサーバーを起動してリクエスト</li>\n</ol>\n<h1 id=\"検証\"><a href=\"#検証\" class=\"headerlink\" title=\"検証\"></a>検証</h1><p>最初に東京都内の限られた範囲でランダムに2点を<br>限られた範囲でのルート検索制度を検証しました.<br>検証範囲は以下になります.<br><img src=\"2020-09-01T095105.png\" alt=\"2020-09-01T095105\"><br>この中で1000回程度Google Direction API, OSRM APIどちらも叩いて統計差がどれくらいか, 変なルート通っていないか比較しました.</p>\n<p>設定はこんな感じです</p>\n<ul>\n<li>両方とも高速道路を通らない</li>\n<li>Direction APIはtrafficMode=optimistic</li>\n<li>OSRMは交通量情報を考慮しない</li>\n<li>OSRMの設定luaファイルはデフォルト (car.lua) のまま</li>\n</ul>\n<h1 id=\"結果\"><a href=\"#結果\" class=\"headerlink\" title=\"結果\"></a>結果</h1><h2 id=\"予測結果\"><a href=\"#予測結果\" class=\"headerlink\" title=\"予測結果\"></a>予測結果</h2><p>ランダムに1つ抜き出してきました.<br>ルートは似たようなルートを通っていますが<br>時間が結構ずれています.<br><img src=\"2020-09-01T095718.png\" alt=\"2020-09-01T095718\"></p>\n<h2 id=\"距離誤差＆時間誤差\"><a href=\"#距離誤差＆時間誤差\" class=\"headerlink\" title=\"距離誤差＆時間誤差\"></a>距離誤差＆時間誤差</h2><p>距離/時間の相対誤差のヒストグラムは以下のようになりました.<br><img src=\"2020-09-01T095458.png\" alt=\"2020-09-01T095458\"><br>ルート可視化と同様に, 距離誤差はデフォルトでもある程度正しいですが<br>時間誤差が大きいので修正が必要です.</p>\n<h2 id=\"速い道路-遅い道路の区分け\"><a href=\"#速い道路-遅い道路の区分け\" class=\"headerlink\" title=\"速い道路, 遅い道路の区分け\"></a>速い道路, 遅い道路の区分け</h2><p>適当に低速, 中速, 高速で分けると<br>高速の比率が大きいほど予測を外していることが分かりました.<br><img src=\"2020-09-01T100026.png\" alt=\"2020-09-01T100026\"></p>\n<h1 id=\"チューニング\"><a href=\"#チューニング\" class=\"headerlink\" title=\"チューニング\"></a>チューニング</h1><p>上記の結果を踏まえてチューニングを行いました.<br>luaファイル内では道路のタグ名ごとに初期設定速度を入れています.<br>今回はそちらを定数倍する大雑把な修正を行いました.</p>\n<p><img src=\"2020-09-01T100311.png\" alt=\"2020-09-01T100311\"></p>\n<p>これで統計的な情報をある程度合わせられる！(チューニングですので)</p>\n<h1 id=\"チューニング結果\"><a href=\"#チューニング結果\" class=\"headerlink\" title=\"チューニング結果\"></a>チューニング結果</h1><p>こんな感じになりました<br>散布図<br><img src=\"2020-09-01T100439.png\" alt=\"2020-09-01T100439\"><br>ヒストグラム<br><img src=\"2020-09-01T100501.png\" alt=\"2020-09-01T100501\"></p>\n<p>平均はあるていど合わせられましたが分散までGoogleの予測と同様とはやはり行かなかったです.<br>交通量の考慮も入ってくるのでそのままの代用は難しいですね.<br>一方, 大きく外すわけではないので裏のロジックに使用したりとか<br>使い道を考えれば導入できるのでは？という感触でした</p>\n<h1 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h1><p>Googleと比較して検証しました<br>全体大きくは外さないですがダメな時もありました<br>どこまでの精度求めるかによりますが<br>存外使えるかもという事で裏側ロジックでの実装と導入<br>どの部分に使うかを模索することになりました.</p>\n",
            "tags": [
                "OSS",
                "OSM",
                "OSRM"
            ]
        },
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/08/18/Arch%20Linux%E3%81%AF%E3%81%84%E3%81%84%E3%81%9E%E3%81%A8%E3%81%84%E3%81%86%E8%A9%B1/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/08/18/Arch%20Linux%E3%81%AF%E3%81%84%E3%81%84%E3%81%9E%E3%81%A8%E3%81%84%E3%81%86%E8%A9%B1/",
            "title": "Arch Linuxはいいぞという話",
            "date_published": "2020-08-18T03:00:00.000Z",
            "content_html": "<h1 id=\"はじめに\"><a class=\"markdownIt-Anchor\" href=\"#はじめに\">#</a> はじめに</h1>\n<p>MONET Technologies 株式会社、2020 年新卒入社の竹内です。</p>\n<p>この記事では、自分のおすすめする　Linux ディストリビューションである Arch Linux についてちょろっと書かせて頂きます。</p>\n<h2 id=\"arch-linuxが好きです\"><a class=\"markdownIt-Anchor\" href=\"#arch-linuxが好きです\">#</a> Arch Linux が好きです。</h2>\n<p>エンジニアなら一度は辿り着く境地、 <strong>「オレオレカスタマイズしたマイスイート PC を作りたい」</strong></p>\n<p>自分はハードウェアがそこそこの PC に、どんなソフトを載せるか、というところが好きです<br>\n (自作 PC 勢のお話も是非聴いてみたいですが)。</p>\n<p>そんな自分が大学生の時からお世話になっているのが、<br>\n<a href=\"https://www.archlinux.jp/\" target=\"_blank\" rel=\"noopener\">Arch Linux</a> という Linux のディストリビューションです。</p>\n<h2 id=\"何がいいの\"><a class=\"markdownIt-Anchor\" href=\"#何がいいの\">#</a> 何がいいの？</h2>\n<ul>\n<li>めちゃくちゃ軽量 &amp; 爆速 (個人の感想です)</li>\n<li>パッケージマネージャが優秀 (ほとんどのソフトを一つのパッケージマネージャで完結できて嬉しい)</li>\n<li>最初にミニマムな要素 (CLI 環境) しか入っていないので、ウィンドウマネージャなどを自分の好みで入れられる</li>\n</ul>\n<p>この辺が自分のツボです。特に、高校生の頃に買った弱い PC に Arch を入れた時、あんなに Windows が重かったのが爆速で動くようになった感動を今でも忘れられません。</p>\n<h2 id=\"まぁ諸説あるけど\"><a class=\"markdownIt-Anchor\" href=\"#まぁ諸説あるけど\">#</a> まぁ諸説あるけど</h2>\n<p>とはいえ、確かに、 <strong>少しメンテナンスが面倒くさい</strong> こともあるかもしれません。<br>\n特に、Arch には始め殆どの要素は入っていない状態からスタートするので、デスクトップ環境を構築するまでが面倒だったり、カーネルのアップデートで起動しなくなったり、ということも無くはないです。</p>\n<p>が、手のかけた子ほど可愛い、そう思いませんか？(個人の意見です)</p>\n<p>何か問題が起きたとしても、<a href=\"https://wiki.archlinux.jp/index.php/%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%9A%E3%83%BC%E3%82%B8\" target=\"_blank\" rel=\"noopener\">Arch Wiki</a> がかなり優秀なので、大抵なんとかなります。</p>\n<p>余談ですが、Ubuntu など別の Linux ディストリビューションを使っても Arch Wiki の情報で助かったりするので、優秀なドキュメントになっているなと感じます。</p>\n<h2 id=\"おすすめのウィンドウマネージャ\"><a class=\"markdownIt-Anchor\" href=\"#おすすめのウィンドウマネージャ\">#</a> おすすめのウィンドウマネージャ</h2>\n<p>せっかくなので、Arch Linux 上での構成を少しだけお話します。</p>\n<p>自分はウィンドウを画面一杯、もしくは二つのウィンドウを右と左に分けて、と言った感じで敷き詰めるのが好きなので、タイル型のウィンドウマネージャが好きです。</p>\n<p>自分の PC に入れているのは、<a href=\"https://awesomewm.org/\" target=\"_blank\" rel=\"noopener\">awesome</a> というウィンドウマネージャです。<br>\nこちらを使うと、ショートカットキーで</p>\n<ul>\n<li>ウィンドウの配置</li>\n<li>フォーカスの切替</li>\n</ul>\n<p>などが簡単にできるので好みです。</p>\n<p><img src=\"2020-08-18T144707.png\" alt=\"2020-08-18T144707\"></p>\n<p>さらに、google-chrome の<a href=\"https://support.google.com/chrome/answer/1649523?co=GENIE.Platform%3DDesktop&amp;hl=ja\" target=\"_blank\" rel=\"noopener\"> remote desktop</a> も入るので、自宅の PC に Arch Linux を入れて、リモートデスクトップを経由して手元の PC から作業、なんてこともできます。</p>\n<p>リモートデスクトップの割に爆速で、中でどんな仕組みになっているか気になっちゃいますね。。。</p>\n<h1 id=\"まとめ\"><a class=\"markdownIt-Anchor\" href=\"#まとめ\">#</a> まとめ</h1>\n<p>Arch Linux はいいぞ。</p>\n",
            "tags": [
                "Arch Linux",
                "Linux"
            ]
        },
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/07/15/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(VSCode%E3%81%AE%E8%A8%AD%E5%AE%9A%E7%B7%A8)/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/07/15/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(VSCode%E3%81%AE%E8%A8%AD%E5%AE%9A%E7%B7%A8)/",
            "title": "技術ブログ始めました(VSCodeの設定編)",
            "date_published": "2020-07-15T23:31:46.000Z",
            "content_html": "<h1 id=\"はじめに\"><a class=\"markdownIt-Anchor\" href=\"#はじめに\">#</a> はじめに</h1>\n<p>MONET Technologies 株式会社、2020 年新卒入社の竹内です。</p>\n<p>この記事では、技術ブログ開始に当たって、VSCode での Hexo 記事執筆環境を導入した話です。</p>\n<p>全体構成のお話は<a href=\"/tech-blog/2020/07/14/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(%E6%A7%8B%E6%88%90%E7%B7%A8)/\" title=\"技術ブログ始めました(構成編)\">技術ブログ始めました(構成編)</a>でお話しています。</p>\n<p>静的サイトジェネレータである Hexo を導入したお話は<a href=\"/tech-blog/2020/07/15/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(Hexo-on-Docker%E7%B7%A8)/\" title=\"技術ブログ始めました(Hexo-on-Docker編)\">技術ブログ始めました(Hexo-on-Docker編)</a>でお話しています。</p>\n<h2 id=\"楽な執筆環境に向けて\"><a class=\"markdownIt-Anchor\" href=\"#楽な執筆環境に向けて\">#</a> 楽な執筆環境に向けて</h2>\n<p>技術ブログ、エンジニアの方なら一度は書こうとするものだと思うのですが、3 ヶ月続けられた方には心からの拍手を送りたいです。</p>\n<p>やはり、モノを書く、アウトプットするのってコストが高いんですよね。単なるメモ程度なら雑に書いても良いわけですが、ブログとして書こうとするとある程度体裁を整えないといけなかったり。。。といったことを考えると、筆が重くなり。。。</p>\n<p>そこで今回は、執筆を楽にするためのツール、VSCode 上のエクステンションを紹介してみます。</p>\n<h2 id=\"vscode-hexo-utils\"><a class=\"markdownIt-Anchor\" href=\"#vscode-hexo-utils\">#</a> vscode-hexo-utils</h2>\n<p>Hexo+VSCode で執筆する際には必須のエクステンションです。<br>\nこの<a href=\"https://marketplace.visualstudio.com/items?itemName=fantasy.vscode-hexo-utils\" target=\"_blank\" rel=\"noopener\"> vscode-hexo-utils</a> を使うと</p>\n<ul>\n<li>記事一覧やタグ一覧を表示するサイドバーの追加</li>\n<li>マークダウンに画像を挿入したプレビュー時、Hexo ならではの画像ディレクトリ構成に対応してプレビューを見せてくれる</li>\n<li>Win:ctrl-alt-v Mac:opt-cmd-v でクリップボードの画像を貼り付け (記事に対応した画像配置用ディレクトリの作成とマークダウン上の参照文記述)</li>\n</ul>\n<p>などなどしてくれるので大分執筆が楽になります。特に画像の挿入は重要なので、開発者には頭が上がりません。</p>\n<h2 id=\"remote-development\"><a class=\"markdownIt-Anchor\" href=\"#remote-development\">#</a> Remote Development</h2>\n<p><a href=\"https://code.visualstudio.com/docs/remote/remote-overview\" target=\"_blank\" rel=\"noopener\">こちら</a>は Docker など、リモートとして作った環境に対して VSCode を接続できるエクステンションです。今回は Docker 上に Hexo や Git を構成しているので、直接接続して、Docker 上のコマンドを呼び出す、なんてことが簡単になります。</p>\n<p>ただ、残念なことが、 <strong>リモートで接続した際にクリップボードが共有化されていないらしく、上記の vscode-hexo-utils の画像コピペ機能が上手く働きません。</strong><br>\nそのため、こちらは残念ながら、執筆中には使えない感じになっています。。。<br>\nもしクリップボードの共有化ができると、</p>\n<ol>\n<li>vscode を直接 Docker に繋げる</li>\n<li>vscode-hexo-utils を使いながら執筆</li>\n<li>直接 Docker 内のコマンドを叩いてデプロイ</li>\n</ol>\n<p>といった使い方ができるようになります。</p>\n<p>もちろん今の Remote Development 機能も大変良いモノで、友人なんかは、RaspberryPi などでリモート環境を作る、VSCode でリモート接続して手元の PC で IoT 開発、なんてこともしているのでおすすめです。</p>\n<h2 id=\"vscodeのタスク機能\"><a class=\"markdownIt-Anchor\" href=\"#vscodeのタスク機能\">#</a> VSCode のタスク機能</h2>\n<p>今回は Docker を通じてのデプロイになりますが、VSCode の方でコマンドを打ってデプロイまで行いたいですよね。<br>\nそこで使うのが、VSCode のタスク機能です。</p>\n<p>参考になるのが<a href=\"https://fereria.github.io/reincarnation_tech/98_Other/VSCode/vscode_create_task/\" target=\"_blank\" rel=\"noopener\">こちら</a>です。</p>\n<p>自分は</p>\n<pre class=\"line-numbers language-language-json\" mdui-tooltip=\"{content: 'language-json'}\"><code class=\"language-language-json\">{\n  \"version\": \"2.0.0\",\n  \"tasks\": [\n    {\n      \"label\": \"deploy-hexo-on-docker\",\n      \"type\": \"shell\",\n      \"command\": \"docker exec -it hexo-domain.com git add . && docker exec -it hexo-domain.com git commit -m 'update ${fileBasenameNoExtension}' && docker exec -it hexo-domain.com git push\"\n    }\n  ]\n}\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>というコマンドを登録して、VSCode から Docker 上の Git を叩き、push するとともにデプロイを行っています。<br>\nこのタスク機能を使えば、任意のコマンドを VSCode 上で使えるので良いですね。</p>\n<h2 id=\"vscode-drawio\"><a class=\"markdownIt-Anchor\" href=\"#vscode-drawio\">#</a> vscode-drawio</h2>\n<p>最後に紹介するエクステンションは、<br>\n<a href=\"https://marketplace.visualstudio.com/items?itemName=hediet.vscode-drawio\" target=\"_blank\" rel=\"noopener\">vscode-drawio</a> です。</p>\n<p>こちらはブラウザ上で動く draw.io を vscode 上で動かそうというモノで、簡単な図を書きたい時に使えます。</p>\n<p>この、なんでもエディタ上にのせてやろうという心意気、自分は嫌いじゃないです。笑</p>\n<h1 id=\"まとめ\"><a class=\"markdownIt-Anchor\" href=\"#まとめ\">#</a> まとめ</h1>\n<p>様々な VSCode のエクステンションがあって、見ていて楽しいです。<br>\nもちろんエンジニアは何を生み出すか、も重要ですが、たまには息抜きに自分の道具を磨いて見るのも良いですね。</p>\n",
            "tags": [
                "hexo",
                "vscode"
            ]
        },
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/07/15/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(Hexo-on-Docker%E7%B7%A8)/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/07/15/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(Hexo-on-Docker%E7%B7%A8)/",
            "title": "技術ブログ始めました(Hexo-on-Docker編)",
            "date_published": "2020-07-15T17:19:39.000Z",
            "content_html": "<h1 id=\"はじめに\"><a class=\"markdownIt-Anchor\" href=\"#はじめに\">#</a> はじめに</h1>\n<p>MONET Technologies 株式会社、2020 年新卒入社の竹内です。</p>\n<p>この記事では、技術ブログ開始に当たって、静的サイトジェネレータ Hexo を導入した話です。</p>\n<p>全体構成のお話は<a href=\"/tech-blog/2020/07/14/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(%E6%A7%8B%E6%88%90%E7%B7%A8)/\" title=\"技術ブログ始めました(構成編)\">技術ブログ始めました(構成編)</a>でお話しています。</p>\n<h2 id=\"docker使ってみます\"><a class=\"markdownIt-Anchor\" href=\"#docker使ってみます\">#</a> Docker 使ってみます</h2>\n<p>さて、それでは本題に入っていきましょう。<br>\n前提として、今回は Hexo 環境を Docker で構築します。<br>\nDocker 環境自体の構築については<a href=\"https://awesome-linus.com/2019/08/17/mac-docker-install/\" target=\"_blank\" rel=\"noopener\">こちら</a>を参照しました。<br>\n筆者は今回初めて Docker を使ってみているので、変なところがあれば指摘していただければと思います。</p>\n<p>流れとしては、</p>\n<ol>\n<li>執筆用 Docker イメージのビルド</li>\n<li>Docker コンテナの実行</li>\n</ol>\n<p>といったところです。</p>\n<h2 id=\"執筆用dockerイメージのビルド\"><a class=\"markdownIt-Anchor\" href=\"#執筆用dockerイメージのビルド\">#</a> 執筆用 Docker イメージのビルド</h2>\n<p>まず、執筆用の Docker イメージをビルドするところから始まります。<br>\nHexo 用の Docker イメージとして<a href=\"https://github.com/spurin/docker-hexo\" target=\"_blank\" rel=\"noopener\">こちら</a>を参考にしました。</p>\n<p>Dockerfile をお好みに記述したら、記述したファイルの存在するディレクトリ上で、</p>\n<pre><code>$ docker build ./ -t docker-hexo\n</code></pre>\n<p>とすれば Docker イメージがビルドされます。</p>\n<p>上記リンクで紹介した Docker ファイルでは</p>\n<ul>\n<li>Hexo 環境の導入</li>\n<li>デプロイ用 Git の導入 (SSH キーの配置も含めて)</li>\n</ul>\n<p>まで行ってくれるようになっています。</p>\n<p>今回は、</p>\n<ol>\n<li>ブログのソースリポジトリを Github にプッシュ</li>\n<li>Github Pages の公開用リポジトリを更新</li>\n</ol>\n<p>という流れを自動化したかったので、Git の hook 機能を使って Hexo のコマンドを紐づけるようにしています。</p>\n<p>具体的には、Hexo 用のデプロイコマンドを記述したファイル <code>pre_push</code>  を作り、</p>\n<pre class=\"line-numbers language-language-sh\" mdui-tooltip=\"{content: 'language-sh'}\"><code class=\"language-language-sh\">#!/bin/sh\n\necho \"---hooked hexo commands start---\"\n#hexo clean\nhexo deploy --generate\necho \"---hooked hexo commands end---\"\necho \"---If you get a \"\"hexo command does not exist\"\" error,\"\necho \"it's seems You' re not running git on Docker.---\"\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>~/.git/hooks/</code>  以下に配置するようにしています。</p>\n<p>今回は push する前という hook になっていますが、複数人で編集することを考えると、リモートリポジトリでのマージが終わったタイミングの方が良かったかもしれないと思っています。が、今回 Github がリモートリポジトリになっているので、リモートサーバ上での hook が実装できず、ひとまず push をトリガーにしています。<br>\nGitlab など自前で Git サーバを立てている際には、</p>\n<ol>\n<li>ブログを書く時にはまず執筆ブランチを切る</li>\n<li>ブログ執筆後、執筆ブランチ上の変更を push</li>\n<li>リモートリポジトリで執筆ブランチをマスターブランチにマージ</li>\n<li>マージ後の hook で公開用リポジトリへソースをデプロイ</li>\n</ol>\n<p>みたいな流れが安全そうです。</p>\n<h2 id=\"dockerコンテナの実行\"><a class=\"markdownIt-Anchor\" href=\"#dockerコンテナの実行\">#</a> Docker コンテナの実行</h2>\n<p>Docker イメージをビルドしたら、</p>\n<pre><code>$ docker create --name=hexo-domain.com \\\n-e HEXO_SERVER_PORT=4000 \\\n-e GIT_USER=&quot;hoge&quot; \\\n-e GIT_EMAIL=&quot;huga@sample.com&quot; \\\n-v /Path/To/Blog/app:/app \\\n-p 4000:4000 \\\ndocker-hexo\n\n$ docker start hexo-domain.com &amp;&amp; docker logs --follow hexo-domain.com\n</code></pre>\n<p>でコンテナを作成し開始します。<br>\nこれを行うことで、Docker コンテナ上の Hexo サーバが動き、</p>\n<p><a href=\"http://localhost:4000\" target=\"_blank\" rel=\"noopener\">http://localhost:4000</a></p>\n<p>を参照することでローカルなサイトのプレビューができるようになります。</p>\n<h1 id=\"まとめ\"><a class=\"markdownIt-Anchor\" href=\"#まとめ\">#</a> まとめ</h1>\n<p>Docker を使うことによって、複数人が使うブログの執筆環境をある程度簡易に構築することができました。<br>\n便利なツールが増える一方、依存関係などで導入が面倒になることもよくあるので、Docker のようなツールもうまく使えるとよりハッピーになりそうですね。</p>\n<p><s>時代の主流は SaaS でローカルに環境を整える場面も少なくなってきそうですが。。。</s></p>\n",
            "tags": [
                "hexo"
            ]
        },
        {
            "id": "https://monet-technologies-com.github.io/tech-blog/2020/07/14/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(%E6%A7%8B%E6%88%90%E7%B7%A8)/",
            "url": "https://monet-technologies-com.github.io/tech-blog/2020/07/14/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E5%A7%8B%E3%82%81%E3%81%BE%E3%81%97%E3%81%9F(%E6%A7%8B%E6%88%90%E7%B7%A8)/",
            "title": "技術ブログ始めました(構成編)",
            "date_published": "2020-07-14T05:09:45.000Z",
            "content_html": "<h1 id=\"はじめに\"><a class=\"markdownIt-Anchor\" href=\"#はじめに\">#</a> はじめに</h1>\n<p>MONET Technologies 株式会社、2020 年新卒入社の竹内です。</p>\n<p>この度、弊社でも社員の技術力向上 &amp; アウトプットのために、技術ブログを開設する運びとなりました。</p>\n<p>記念すべき 1 回目の記事は、この技術ブログの立ち上げについて一通り書きます。</p>\n<h2 id=\"技術ブログの選定\"><a class=\"markdownIt-Anchor\" href=\"#技術ブログの選定\">#</a> 技術ブログの選定</h2>\n<p>技術ブログを作成するに当たって考えたのは、</p>\n<ol>\n<li>サーバの維持コスト</li>\n<li>記事の管理コスト</li>\n<li>執筆環境</li>\n</ol>\n<p>の 3 点です。技術ブログを公開するというということは当然 Web サーバが必要になるわけですが、そこにコストやメンテナンスが必要になると継続するのが面倒です。なので、何か外部のサービスを使って公開したいという要求があります。<br>\nまた、ページを編集したら、編集履歴や差分まで管理したいです。<br>\n更に、執筆環境としては、普段コードを書いたりするエディタを使ってそのまま書きたいですよね。</p>\n<p>ということで、今回は静的サイトジェネレータ<a href=\"https://hexo.io/\" target=\"_blank\" rel=\"noopener\"> Hexo</a> と<a href=\"https://pages.github.com/\" target=\"_blank\" rel=\"noopener\"> Github Pages</a> を使って技術ブログを作ってみることにしました。ただ、今回用いる Hexo は Node.js で作られており、バージョン管理などが面倒です。そこで、今回は、</p>\n<ul>\n<li>生成環境：Docker 上の Hexo</li>\n<li>執筆環境：Visual Studio Code などの各自のエディタ</li>\n<li>公開環境：Github Pages</li>\n</ul>\n<p>という構成で全体を組みました (もちろん執筆環境はお好きなエディタを使ってください)。</p>\n<p>全体構成のイメージはこんな感じです。</p>\n<p><img src=\"2020-08-06T103219.png\" alt=\"2020-08-06T103219\"></p>\n<p>次回からそれぞれの環境について執筆していきます。</p>\n<h1 id=\"まとめ\"><a class=\"markdownIt-Anchor\" href=\"#まとめ\">#</a> まとめ</h1>\n<p>技術ブログを始めるので皆様ゆるゆるとお付き合いください！</p>\n",
            "tags": [
                "hexo",
                "vscode",
                "github",
                "docker"
            ]
        }
    ]
}